apply plugin: "com.android.library"
apply plugin: "kotlin-multiplatform"

version = project.hydra_log_version
group = "ru.pocketbyte.hydra"

android {
    compileSdkVersion project.android_sdk_compile
    buildToolsVersion project.android_build_tool_version

    defaultConfig {
        minSdkVersion project.android_sdk_min
        targetSdkVersion project.android_sdk_target
        versionCode 1
        versionName project.version
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}

kotlin {
    android {
        publishLibraryVariants("release")
    }

    targets {
        jvm("jvm")
        android("android")

        js("js")

        macosX64("macos")
        iosX64("iosX64")
        iosArm64("iosArm64")
        iosArm32("iosArm32")

        mingwX64("mingw")
    }

    sourceSets {
        // =================================
        // Main Source Sets
        commonMain.dependencies {
            api 'org.jetbrains.kotlin:kotlin-stdlib-common'
        }

        commonTest {
            dependsOn commonMain
            dependencies {
                api "org.jetbrains.kotlin:kotlin-test"
                api "org.jetbrains.kotlin:kotlin-test-junit"
            }
        }

        // =================================
        // JVM based Source Sets
        jvmCommonMain {
            dependsOn commonMain
            dependencies {
                api 'org.jetbrains.kotlin:kotlin-stdlib'
            }
        }

        jvmMain {
            dependencies {
                api 'org.jetbrains.kotlin:kotlin-stdlib'
            }
        }

        androidMain {
            dependencies {
                api 'org.jetbrains.kotlin:kotlin-stdlib'
                api "org.jetbrains.kotlin:kotlin-stdlib-jdk8"
            }
        }

        configure([jvmMain, androidMain]) {
            dependsOn jvmCommonMain
        }

        // Tests
        jvmCommonTest {
            dependsOn jvmCommonMain
            dependsOn commonTest
        }

        configure([jvmTest]) {
            dependsOn jvmCommonTest
            dependsOn jvmMain
        }

        configure([androidTest]) {
            dependsOn jvmCommonTest
            dependsOn androidMain
        }

        // =================================
        // JS Source Sets
        jsMain {
            dependencies {
                api 'org.jetbrains.kotlin:kotlin-stdlib'
                api "org.jetbrains.kotlin:kotlin-stdlib-js"
            }
        }

        jsTest {
            dependsOn jsMain
            dependencies {
                api "org.jetbrains.kotlin:kotlin-test"
                api "org.jetbrains.kotlin:kotlin-test-js"
            }
        }

        // =================================
        // Native based Source Sets
        nativeCommonMain {
            dependsOn commonMain
        }
        nativeMain {}
        appleMain {}

        configure([nativeMain, appleMain]) {
            dependsOn nativeCommonMain
        }

        configure([mingwMain]) {
            dependsOn nativeMain
        }

        configure([iosX64Main, iosArm64Main, iosArm32Main, macosMain]) {
            dependsOn appleMain
        }

        //Tests

        nativeCommonTest {
            dependsOn nativeCommonMain
            dependsOn commonTest
        }

        nativeTest {
            dependsOn nativeMain
            dependsOn nativeCommonTest
        }

        appleTest {
            dependsOn appleMain
            dependsOn nativeCommonTest
        }

        configure([mingwTest]) {
            dependsOn nativeTest
        }

        configure([iosX64Test, iosArm64Test, iosArm32Test, macosTest, mingwTest]) {
            dependsOn appleTest
        }
    }
}

//==================================================================================================
// Publication
//==================================================================================================

apply plugin: "maven-publish"
apply plugin: "com.github.dcendents.android-maven"

publishing {
    publications {
        kotlinMultiplatform {
            artifactId = project.name
        }
    }
    repositories {
        maven {
            url = "https://api.bintray.com/content/pocketbyte/hydra/${project.name}/${project.version}"
            credentials {
                username project.hasProperty('bintray.publish.user') ? project.property('bintray.publish.user') : ''
                password project.hasProperty('bintray.publish.apikey') ? project.property('bintray.publish.apikey') : ''
            }
        }
    }
}

install {
    repositories.mavenInstaller {
        pom {
            project {
                packaging 'aar'
                groupId project.group
                artifactId "${project.name}-android"
            }
            withXml {
                def root = asNode()

                def dependencies = root.get('dependencies') ?: root.appendNode('dependencies')

                // Add common dependency
                def commonDependency = dependencies.appendNode('dependency')
                commonDependency.appendNode('groupId', project.group)
                commonDependency.appendNode('artifactId', "${project.name}-jvm")
                commonDependency.appendNode('version', project.version)
                commonDependency.appendNode('scope', 'runtime')
            }
        }
    }
}